"use strict";var l=Object.defineProperty;var u=(r,e,a)=>e in r?l(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a;var d=(r,e,a)=>u(r,typeof e!="symbol"?e+"":e,a);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("./types.cjs");class m{constructor(e,a,t,i){d(this,"config");d(this,"callbacks");d(this,"publishManager");d(this,"mediaManager");d(this,"selfId",null);this.config=e,this.callbacks=a,this.publishManager=t,this.mediaManager=i}checkSelfParticipant(e,a){const t=new Set(this.publishManager.getStreams().map(n=>{var o;return(o=n.mediaStreamTrack)==null?void 0:o.id}).filter(n=>n));a.some(n=>n.mediaStreamTrack&&t.has(n.mediaStreamTrack.id))&&(this.selfId=e.id,this.mediaManager.setSelfId(e.id))}handleSeiMessage(e,a){const t=a.payload instanceof ArrayBuffer?a.payload:a.payload instanceof Uint8Array?a.payload.buffer.slice(a.payload.byteOffset,a.payload.byteOffset+a.payload.byteLength):null;if(t)try{const i=JSON.parse(new TextDecoder().decode(t));i.type&&(this.applyCommand(i),this.callbacks.onCommandReceived&&this.callbacks.onCommandReceived(i,e.id))}catch{console.warn("Failed to parse SEI message")}}applyCommand(e){const a=e.targetParticipantId,t=this.selfId&&a&&this.selfId===a;switch(e.type){case s.CommandType.MuteAudio:a&&(t?this.publishManager.setLocalAudioEnabled(!1):this.mediaManager.updateSubscription(a));break;case s.CommandType.UnmuteAudio:a&&(t?this.publishManager.setLocalAudioEnabled(!0):this.mediaManager.updateSubscription(a));break;case s.CommandType.MuteVideo:a&&(t?this.publishManager.setLocalVideoEnabled(!1):this.mediaManager.updateSubscription(a));break;case s.CommandType.UnmuteVideo:a&&(t?this.publishManager.setLocalVideoEnabled(!0):this.mediaManager.updateSubscription(a));break;case s.CommandType.StopPublishing:t&&this.publishManager.stopPublishing(),a&&this.mediaManager.updateStreamStatus(a);break;case s.CommandType.StartPublishing:t&&this.publishManager.startPublishing().catch(()=>{}),a&&this.mediaManager.updateStreamStatus(a);break}}async broadcastCommand(e,a=3){if(this.config.role!=="admin")return!1;const t=this.publishManager.getStreams().find(o=>{var c;return((c=o.mediaStreamTrack)==null?void 0:c.kind)==="video"});if(!t)return!1;const i=new TextEncoder().encode(JSON.stringify({...e,timestamp:Date.now()})),n=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);try{return await t.insertSeiMessage(n,{repeatCount:a}),!0}catch{try{return await t.insertSeiMessage(n),!0}catch{return!1}}}muteAudio(e){this.config.role==="admin"&&(this.broadcastCommand({type:s.CommandType.MuteAudio,targetParticipantId:e}),this.callbacks.onParticipantMuted&&this.callbacks.onParticipantMuted(e,"audio"))}unmuteAudio(e){this.config.role==="admin"&&(this.broadcastCommand({type:s.CommandType.UnmuteAudio,targetParticipantId:e}),this.callbacks.onParticipantUnmuted&&this.callbacks.onParticipantUnmuted(e,"audio"))}muteVideo(e){this.config.role==="admin"&&(this.broadcastCommand({type:s.CommandType.MuteVideo,targetParticipantId:e}),this.callbacks.onParticipantMuted&&this.callbacks.onParticipantMuted(e,"video"))}unmuteVideo(e){this.config.role==="admin"&&(this.broadcastCommand({type:s.CommandType.UnmuteVideo,targetParticipantId:e}),this.callbacks.onParticipantUnmuted&&this.callbacks.onParticipantUnmuted(e,"video"))}}exports.CommandManager=m;
