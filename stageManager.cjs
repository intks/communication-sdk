"use strict";var h=Object.defineProperty;var o=(i,e,s)=>e in i?h(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s;var a=(i,e,s)=>o(i,typeof e!="symbol"?e+"":e,s);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("amazon-ivs-web-broadcast");class g{constructor(e,s,n,r){a(this,"config");a(this,"callbacks");a(this,"publishManager");a(this,"subscriptionManager");a(this,"stage",null);a(this,"strategyRefreshTimerId",null);a(this,"handlers",{});this.config=e,this.callbacks=s,this.publishManager=n,this.subscriptionManager=r}setEventHandlers(e){this.handlers=e}async initialize(){try{this.stage=new t.Stage(this.config.token,this.createStrategy()),this.registerEvents(),await this.stage.join()}catch(e){throw console.error("Stage initialization failed:",e),e}}createStrategy(){return{stageStreamsToPublish:()=>this.publishManager.getStreams(),shouldPublishParticipant:()=>this.publishManager.shouldPublish(),shouldSubscribeToParticipant:e=>this.subscriptionManager.getSubscribeType(e),subscribeConfiguration:this.config.enableInBandMessaging!==!1?()=>({inBandMessaging:{enabled:!0}}):void 0}}registerEvents(){this.stage&&(this.handlers.onConnectionStateChanged&&this.stage.on(t.StageEvents.STAGE_CONNECTION_STATE_CHANGED,this.handlers.onConnectionStateChanged),this.handlers.onParticipantJoined&&this.stage.on(t.StageEvents.STAGE_PARTICIPANT_JOINED,this.handlers.onParticipantJoined),this.handlers.onParticipantLeft&&this.stage.on(t.StageEvents.STAGE_PARTICIPANT_LEFT,this.handlers.onParticipantLeft),this.handlers.onParticipantStreamsAdded&&this.stage.on(t.StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED,this.handlers.onParticipantStreamsAdded),this.handlers.onParticipantStreamsRemoved&&this.stage.on(t.StageEvents.STAGE_PARTICIPANT_STREAMS_REMOVED,this.handlers.onParticipantStreamsRemoved),this.handlers.onStreamSeiMessageReceived&&this.config.enableInBandMessaging!==!1&&this.stage.on(t.StageEvents.STAGE_STREAM_SEI_MESSAGE_RECEIVED,this.handlers.onStreamSeiMessageReceived))}unregisterEvents(){this.stage&&(this.handlers.onConnectionStateChanged&&this.stage.off(t.StageEvents.STAGE_CONNECTION_STATE_CHANGED,this.handlers.onConnectionStateChanged),this.handlers.onParticipantJoined&&this.stage.off(t.StageEvents.STAGE_PARTICIPANT_JOINED,this.handlers.onParticipantJoined),this.handlers.onParticipantLeft&&this.stage.off(t.StageEvents.STAGE_PARTICIPANT_LEFT,this.handlers.onParticipantLeft),this.handlers.onParticipantStreamsAdded&&this.stage.off(t.StageEvents.STAGE_PARTICIPANT_STREAMS_ADDED,this.handlers.onParticipantStreamsAdded),this.handlers.onParticipantStreamsRemoved&&this.stage.off(t.StageEvents.STAGE_PARTICIPANT_STREAMS_REMOVED,this.handlers.onParticipantStreamsRemoved),this.handlers.onStreamSeiMessageReceived&&this.stage.off(t.StageEvents.STAGE_STREAM_SEI_MESSAGE_RECEIVED,this.handlers.onStreamSeiMessageReceived))}refreshStrategy(){this.strategyRefreshTimerId&&clearTimeout(this.strategyRefreshTimerId),this.strategyRefreshTimerId=window.setTimeout(()=>{var e;try{(e=this.stage)==null||e.refreshStrategy()}catch(s){console.error("Failed to refresh strategy:",s)}this.strategyRefreshTimerId=null},0)}leave(){var e;this.unregisterEvents(),(e=this.stage)==null||e.leave(),this.stage=null}handleConnectionStateChanged(e){e===t.StageConnectionState.CONNECTED&&this.callbacks.onConnected?this.callbacks.onConnected():e===t.StageConnectionState.DISCONNECTED&&this.callbacks.onDisconnected&&this.callbacks.onDisconnected()}}exports.StageManager=g;
