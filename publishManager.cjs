"use strict";var r=Object.defineProperty;var d=(o,i,e)=>i in o?r(o,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[i]=e;var a=(o,i,e)=>d(o,typeof i!="symbol"?i+"":i,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("amazon-ivs-web-broadcast"),n=require("./utils/media.cjs");class h{constructor(i,e){a(this,"config");a(this,"callbacks");a(this,"localStreams",[]);a(this,"localStream",null);a(this,"isPublishing",!1);a(this,"isLocalAudioEnabled",!0);a(this,"defaultVideoResolution",{width:1280,height:720});this.config=i,this.callbacks=e}async startPublishing(){try{if(this.localStreams=[],this.config.videoInputDeviceId){const e=(await n.openVideoInputDevice(this.config.videoInputDeviceId,this.defaultVideoResolution.width,this.defaultVideoResolution.height)).getVideoTracks()[0];if(e){const l=this.config.enableInBandMessaging!==!1?{inBandMessaging:{enabled:!0}}:void 0;this.localStreams.push(new c.LocalStageStream(e,l))}}if(this.config.audioInputDeviceId){const e=(await n.openAudioInputDevice(this.config.audioInputDeviceId)).getAudioTracks()[0];e&&(e.enabled=this.isLocalAudioEnabled,this.localStreams.push(new c.LocalStageStream(e)))}this.localStreams.length>0&&(this.localStream=new MediaStream(this.localStreams.map(i=>i.mediaStreamTrack).filter(i=>i)),this.callbacks.onLocalStreamReady&&this.callbacks.onLocalStreamReady(this.localStream),this.config.localVideoElement&&(this.config.localVideoElement.srcObject=this.localStream,this.config.localVideoElement.muted=!0,this.config.localVideoElement.playsInline=!0,this.config.localVideoElement.play().catch(()=>console.warn("Failed to play local video")))),this.isPublishing=!0,this.callbacks.onPublishingStarted&&this.callbacks.onPublishingStarted()}catch(i){throw console.error("Failed to start publishing:",i),this.callbacks.onError&&this.callbacks.onError(i),i}}stopPublishing(){this.localStream&&(this.localStream.getTracks().forEach(i=>i.stop()),this.localStream=null),this.localStreams.forEach(i=>{var e;return(e=i.mediaStreamTrack)==null?void 0:e.stop()}),this.localStreams=[],this.isPublishing=!1,this.callbacks.onPublishingStopped&&this.callbacks.onPublishingStopped()}toggleVideo(){if(!this.localStream)return;const i=this.localStream.getVideoTracks()[0];i&&(i.enabled=!i.enabled,this.callbacks.onVideoToggled&&this.callbacks.onVideoToggled(i.enabled))}toggleAudio(){this.setLocalAudioEnabled(!this.isLocalAudioEnabled)}setLocalAudioEnabled(i){var l;this.isLocalAudioEnabled=i;const e=(l=this.localStreams.find(s=>{var t;return((t=s.mediaStreamTrack)==null?void 0:t.kind)==="audio"}))==null?void 0:l.mediaStreamTrack;i&&!e&&this.config.audioInputDeviceId?n.openAudioInputDevice(this.config.audioInputDeviceId).then(s=>{const t=s.getAudioTracks()[0];t&&(this.localStreams.push(new c.LocalStageStream(t)),this.localStream?this.localStream.addTrack(t):this.localStream=new MediaStream([t]),this.config.localVideoElement&&(this.config.localVideoElement.srcObject=this.localStream,this.config.localVideoElement.play().catch(()=>{})),this.callbacks.onAudioToggled&&this.callbacks.onAudioToggled(!0))}).catch(()=>{this.callbacks.onAudioToggled&&this.callbacks.onAudioToggled(!1)}):e&&(e.enabled=i,this.callbacks.onAudioToggled&&this.callbacks.onAudioToggled(i))}setLocalVideoEnabled(i){if(!this.localStream)return;const e=this.localStream.getVideoTracks()[0];e&&(e.enabled=i,this.callbacks.onVideoToggled&&this.callbacks.onVideoToggled(i))}getStreams(){return this.localStreams.filter(i=>{const e=i.mediaStreamTrack;return e?e.kind==="audio"?this.isLocalAudioEnabled&&e.enabled:!0:!1})}shouldPublish(){return this.config.role==="admin"||this.config.role==="user"&&this.isPublishing}}exports.PublishManager=h;
